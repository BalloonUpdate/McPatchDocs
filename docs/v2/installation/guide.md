---
title: 安装教程
---

## 一、下载文件

在开始安装之前，要从 [Releases](https://github.com/BalloonUpdate/McPatch2/releases) 提前下载好客户端程序（mcpatch-manager）和管理端程序（mcpatch-client）。

- mcpatch-manager 是管理端程序，用来打更新包和日常维护工作。同时也提供一个内置的开箱即用服务端。这个文件通常放在自己电脑上，或者放在服务器上都可。
- mcpatch-client 是客户端程序，用来更新Minecraft客户端的文件。通常配置好后和Mc客户端一起打包发给玩家，以实现远程更新文件的效果。

:::tip

如果提示找不到 VCRUNTIME140.dll 文件。请 [安装 VC++ 2015 运行库](../faq.md#由于找不到VCRUNTIME140.dll，无法继续执行代码)。

:::

## 二、配置管理端

:::note[小知识]

管理端的作用是打包和管理更新包，服主日常维护更新文件时，都需要和它打交道。

:::

首先在桌面上（或者任何你喜欢的地方）创建一个目录，叫`guanli`。然后将刚刚下载好的管理端程序放进去。

双击即可启动管理端。启动成功后可以看到有`> `的字样，此时进入了交互式命令行模式。按回车就可以出现管理端支持的命令列表。

我们输出`check`命令按下回车键，它会提示修改的文件数量为多少多少，我们先忽视这个消息。

回到`guanli`目录下，你会注意到管理端程序旁边新增了一个名为`workspace`的文件夹，这就是工作空间目录。

此时，`guanli`目录大概长这样：
```
guanli/
├─ workspace/                           # 工作空间
└─ m-0.0.11-x86_64-pc-windows-msvc.exe  # 管理端程序
```

无论是要向客户端添加新文件、修改现有文件、删除文件、移动文件，你只需要在`workspace`目录中对相应的文件进行操作。每当管理端进行打包操作时，管理端会对比`workspace`目录中文件的变化，来生成更新包。

## 三、放入要更新的文件

一般来说，整合包本体是通过 浏览器直链/QQ群 下载的，而后续的文件修改（模组和配置更新）会通过 McPatch 完成。

那么，下面是一些典型的栗子可以参考（不存在的文件夹需要手动创建）：

---

+ 要新增或更新.minecraft目录旁边的`新玩家进服教程.txt`
  + 复制`新玩家进服教程.txt`文件
  + 粘贴到`guanli/workspace/新玩家进服教程.txt`
```
# 整合包目录结构
客户端整合包/
├─ .minecraft/
│   └─ 各种文件
├─ 新玩家进服教程.txt
└─ PCL启动器.exe

# workspace 目录结构
guanli/
├─ workspace/
│  └─ 新玩家进服教程.txt
└─ m-0.0.11-x86_64-pc-windows-msvc.exe
```
如果客户端没有该文件，客户端会下载新的 `新玩家进服教程.txt`放到这里。
如果客户端有该文件，客户端会下载新的 `新玩家进服教程.txt` 并覆盖老的 `新玩家进服教程.txt`。

---

+ 如果你开了版本隔离，模组文件通常会放在 versions 目录下，那么
  + 复制`.minecraft/versions/<版本名称>/mods`目录
  + 粘贴到`guanli/workspace/.minecraft/versions/<版本名称>/mods`
  + 其它受版本隔离影响的文件也是同理，也需要复制到 versions 目录下才能被 Minecraft 读到

:::tip

若开启版本隔离，那么要更新的实际上是 versions 目录下的 mods 文件夹。如果还傻乎乎地直接把文件丢到`.minecraft/mods`目录下敷衍了事，游戏是读取不到的。

:::

---

+ 要更新JEI模组的配置文件（开启版本隔离）
  + 复制`.minecraft/versions/<版本名称>/config/jei/jei.cfg`文件
  + 粘贴到`guanli/workspace/.minecraft/versions/<版本名称>/config/jei/jei.cfg`
```
# 整合包目录结构
客户端整合包/
├─ .minecraft/
│  ├─ versions/
│  │  └─ <版本名称>/
│  │     ├─ config/
│  │     │  ├─ jei/
│  │     │  │  └─ jei.cfg # 要更新这个配置文件
│  │     │  └─ 其他模组配置
│  │     └─ 其他游戏文件
│  └─ 其他文件
└─ PCL启动器.exe

# workspace 目录结构
guanli/
├─ workspace/
│  └─ .minecraft/
│     └─ versions/
│        └─ <版本名称>/
│           └─ config/
│              └─ jei/
│                 └─ jei.cfg
└─ m-0.0.11-x86_64-pc-windows-msvc.exe
```

---

+ 要重命名/移动/删除文件
  + McPatch 支持重命名/移动文件，只要文件内容不变，就不需要客户端再次下载该文件，客户端会在本地直接操作。
  + 避免单纯的将`Abc.jar`重命名为`abc.jar`这种仅修改大小写部分的重命名/移动文件，McPatch2 暂时不支持这样操作，管理端在打包时会报错。
  + 删除文件时不会校验原文件的内容，直接删除。

---

+ 要更新某些模组（删除`workspace`中不存在的文件）
  + 因为模组更新后文件名和内容都会改变（例如`jei-v1.jar`会变成`jei-v2.jar`），所以单纯添加新的模组文件会造成客户端同时存在两个相同但不同版本的模组，所以需要删除旧的模组。
  + 一般来说 McPatch 是用来后续更新，所以一开始就在整合包里的文件（模组）不在`workspace`中，这就造成了无法删除该文件（因为本身就没有，还怎么进行删除这个操作）。
  + 那么可以使用以下方法：

1. 在对应位置添加想要被删除的文件（也就是老的模组文件，如`jei-v1.jar`），然后进行打包。此时`workspace`就有这个文件了。
2. 删除该文件，并且添加更新后的模组（`jei-v2.jar`），然后进行打包。此时客户端不仅会下载更新后的模组，同时也会删除老的模组文件。（文件夹也可以用这种方式删除）
3. 不用担心这个操作会带来额外的流量消耗。因为客户端更新时，如果发现某个文件在前一个包里存在，但是后一个包里紧接着又被删除了，客户端会自动跳过对这个文件下载（删重），以达到优化的目的。
  
---

## 四、打包

切回管理端窗口。（如果你已经退出了，那么再次双击运行即可）

看到`> `的字样后。输入`pack <version>`即可开始打包，`<version>`是要打包的版本号，不能和现有的重复。

版本号只能包括大小写字母，数字，以及`!@#$()_+-=;',.`这几个符号，不要使用中文，空格，或其它字符，会出问题。

:::tip

如果要写版本更新记录，需要在打包开始之前，提前把更新记录用使用utf-8编码写在`guanli/logs.txt`文件里，管理端打包时会自动读取这个文件。

:::

看到“打包完成！”的字样即代表打包成功了，更新包会存放在public目录下，会按版本号进行命名。

此时，`guanli`目录大概长这样：
```
guanli/
├─ public/                              # 存放更新包
│  ├─ v1.tar
│  └─ index.json
├─ workspace/                           # 工作空间
│  └─ 各种文件
├─ logs.txt                             # 更新记录
├─ config.toml                          # 上传脚本配置文件
└─ m-0.0.11-x86_64-pc-windows-msvc.exe  # 管理端程序
```

如果对打包结果不放心，可以使用`test`对更新包进行校验，这会模拟客户端的解压过程，检查文件是否损坏。

:::danger[万分小心！！！]

已经打好的更新包文件（也就是`public`目录里面的文件）不能手动删除也不能修改里面的文件，这会导致数据损坏，应该再打一个新的包来替代删除旧的包。（~~自己手欠删出问题别来找我~~）

:::

## 五、后续打包

后续的文件维护很简单！直接对工作空间目录下的文件或者目录进行增加，删除，修改，重命名即可，想怎么操作怎么操作。修改到自己满意为止后，完后输入`pack <version>`打包即可。

管理端会自动感知到你做的所有文件修改，并打成更新包，再将这些修改同步到客户端。整个过程操作起来方便和直观，只需要把工作空间目录当成普通目录一样修改就好了。

如果对工作空间目录下的文件进行了修改，但又发现改的不对。可以使用管理端的`revert`命令来丢弃刚刚的修改，将文件状态退回上一次打包的时候。

下面是一些管理端中，常被问到的问题：

1. 支持所有文件操作：包括移动，修改，覆盖，新建，删除，复制等等等等，文件夹同理
2. 支持更新加密的压缩包。只需要当普通文件一样用新版替换覆盖旧版就行
3. 新旧文件同名，但是文件内容变了也能检测到。因为打包时会检查文件校验，文件里任何字节发生变化，管理端都能感知到。
4. 避免单纯的将`Abc.jar`重命名为`abc.jar`这种仅修改大小写部分，同时没有改动文件所在目录和文件内容的行为。这种单纯原地修改大小写重命名的行为，管理端会出bug

## 六、启动服务端

:::tip[小知识]

管理端除了管理更新包以外，还自带一个内置服务端的功能。这是给小白用户准备的功能。不仅能免去额外搭建HTTP服务端的繁琐过程，还能免备案使用

:::

客户端程序支持多种更新协议，比如HTTP协议。WEBDAV协议，私有协议等。

由于我们是初次上手本软件，这里使用管理端自带的服务端功能进行教程演示。在 [最佳实践](/docs/v2/practices) 中也有其他部署方式，以适应复杂的部署需求。

管理端自带的服务端使用私有协议，这是mcpatch自己基于tcp设计的一套文件传输协议。相较HTTP协议的优点是配置难度低和免备案即可使用。其开箱即用的特性，非常适合小服使用或者本地测试。

要启动管理端自带的服务端功能，首先需要启动管理端，然后输出`serve 6700`按回车。（注意命令是serve不是server不要打错了）

这里的`serve`表示启动自带的服务端，6700代表监听在哪个端口上，默认是6700。

想要关闭服务端可以叉掉终端的窗口，或者按Ctrl + C即可。

---

通常我们都习惯从bat启动这个自带服务端。服务端除了使用交互式命令行启动以外，也支持从普通命令行参数启动。

我们可以在`guanli`目录下，也就是管理端程序旁边新建一个`serve.bat`文件。（名字随意）

然后将下面的内容粘贴进去，然后双击启动即可。（其中`<mcpatch-manager>`需要替换成实际的文件名）

```bat
@echo off
<mcpatch-manager> serve 6700
```

一般都是同时开两个管理端进程实例，一个打包用，用完叉掉。一个跑内置服务端，一直挂在后台

如果需要在内网穿透或者端口映射环境下使用管理端自带的服务端，协议记得选择TCP协议（必须是严格TCP别的协议不行）

## 七、配置客户端

当管理端部署安装好之后，就可以开始配置客户端程序这边了。

:::tip[推荐的步骤，但不强制]

在开始配置客户端程序之前，建议先将Mc客户端整个文件夹压缩一遍备份，避免调试更新的过程中，误删了什么文件没法恢复了。

:::

将客户端程序放到Minecraft客户端的`.minecraft/gengxin`目录里面（需要手动创建），然后直接双击运行exe。

不出意外的话，客户端会报错无法连接之类的错误，不用管这个报错，直接关掉。

此时它会生成一个配置文件`mcpatch.yml`，我们需要打开编辑。

这里唯一需要修改的是`urls`选项，这个参数控制更新服务器的地址，默认是本机地址`mcpatch://127.0.0.1:6700`。

如果你的服务端是管理端自带的，且监听的端口也是默认的6700的话，那么这里可以不用修改端口。

如果你的服务端没有和客户端程序部署在同一台电脑上，那么记得修改这个127.0.0.1的IP地址，不然铁定连不上。只需要将这个地址修改成自己服务器的ip和端口即可。

`urls`支持`base64`编码。（例如`mcpatch://127.0.0.1:80`的`base64`编码为`bWNwYXRjaDovLzEyNy4wLjAuMTo4MA==`）

客户端配置文件中的其它选项都有独立的注释说明，可以按需修改。

## 八、一键启动

客户端每次都要手动双击运行很是麻烦，可以借助一些方法在游戏启动时自动进行更新。

首先到[BalloonUpdate/McPatch2Loader](https://github.com/BalloonUpdate/McPatch2Loader/releases)下载最新版的加载器文件。

打开Minecraft客户端的`.minecraft/gengxin`目录。将加载器放在里面，和客户端程序放到一起。

在此处创建“启动列表”文件，叫`startlist.txt`。

将客户端程序的文件名复制，比如`mcpatch-client-0.0.0.exe`。粘贴到`startlist.txt`里，保存关闭。

此时，目录结构大概长这样。
```
客户端整合包/
├─ .minecraft/
│  ├─ gengxin/
│  │  ├─ mcpatch-client-0.0.0.exe
│  │  ├─ startlist.txt
│  │  ├─ loader-2.jar
│  │  ├─ mcpatch.yml
│  │  └─ mcpatch.log
│  └─ versions/
└─ PCL启动器.exe
```

打开Minecraft启动器（任意启动器均可，官方启动器除外），调整游戏版本设置，找到Java虚拟机参数（或者JVM 参数）。

在参数的开头插入这串代码`-javaagent:gengxin/《举个栗子》.jar -其他参数:其他参数`（注意.jar后面还有个空格也不要漏），然后回到启动器主界面。

`《举个栗子》`要换成loader.jar的实际文件名，这里只是举例，下文同理。

点击Minecraft启动器的“启动游戏”按钮，一切顺利的话，在启动Minecraft主进程之前，就会启动更新了。

如果启动游戏提示`Error opening zip file or JAR manifest missing`，说明填写的jar文件找不到。

有时候你可能会好奇，明明这个文件在`gengxin`目录下面，怎么就会找不到呢？

这个问题其实不怪你，它通常和MC游戏的启动设置有关，其中影响最明显的就是版本隔离选项！

一般不开版本隔离功能时，使用`-javaagent:gengxin/《举个栗子》.jar `就可以顺利启动，但是开启版本隔离后就不行了。

这是因为开启版本隔离后，javaagent参数的判定路径（也就是工作目录）会发生改变。没开启时，是从.minecraft目录下开始计算，这也是为什么loader明明放在`.minecraft/gengxin`下，但参数里却只需要填写`gengxin/《举个栗子》.jar`，而不需要加上`.minecraft`的原因。

当开启版本隔离后，这个判定路径多数情况下都会变成从`.minecraft/version/xxxx/`目录下开始计算。

此时将参数改成`-javaagent:../../gengxin/《举个栗子》.jar `通常就可以正常启动了。其中`../`表示返回上级目录，可以不断连用来多次返回上级目录。

从版本文件夹`.minecraft/version/xxxx/`开始，两个`../`正好抵消掉`version/xxxx/`，使其判定路径变成`.minecraft/`，那么再加上`gengxin/《举个栗子》.jar`，就正好能定位到loader的实际位置了，游戏便可以正常启动了。

## 九、经常被问到的问题

### 文件更新位置

客户端程序会自动搜索`.minecraft`的父目录作为更新起始位置，到处移动客户端程序（不管套几层文件夹）都不会影响更新起始位置。

如果要调整这个机制，可以修改配置文件里的`base-path`选项。

### 版本号不是判断版本新旧的依据

版本号只是一个普通的标签，是给人类看的，程序不会解析对比版本号的文字，也不作为任何判断版本前后的依据。

版本号的判断顺序的按打包时间来计算的，后打的版本总是新版本。
